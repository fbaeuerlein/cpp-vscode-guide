
# Code coverage <!-- omit in toc -->

## Table of contents <!-- omit in toc -->

- [Overview](#overview)
- [Setup coverage for CMake builds](#setup-coverage-for-cmake-builds)
- [Using lcov to generate coverage info file](#using-lcov-to-generate-coverage-info-file)
- [Automate coverage extraction with tasks](#automate-coverage-extraction-with-tasks)
- [Extension](#extension)

## Overview

This documentation shows how to configure and evaluate the code coverage of your application under Linux with lcov.

## Setup coverage for CMake builds

Compile your application/tests with `-fprofile-arcs -ftest-coverage`. For linking the `--coverage` flag is needed.

An easy way to propagate these flags to CMake ist the use of the `.vscode/cmake-variants.yaml`.
There you can set different variants of your toolchain. Below you can see an example for adding coverage instrumentation with compiler flags:

    buildType:
      default: debug
      choices:
        debug:
          short: Debug
          long: Emit debug information
          buildType: Debug
        release:
          short: Release
          long: Optimize generated code
          buildType: Release

    coverage:
      default: no_coverage
      choices:
        # enable coverage by additional compiler flags
        coverage:
          short: cov
          long: build with coverage instrumentation
          settings:
            CMAKE_CXX_FLAGS: "-fprofile-arcs -ftest-coverage "
            CMAKE_C_FLAGS: "-fprofile-arcs -ftest-coverage"
            CMAKE_EXE_LINKER_FLAGS: "--coverage"
        no_coverage:
          short: no_coverage
          long: build without coverage

After changing the `cmake-variants.yaml`, you can choose a build variant (click 1 and select in 2) as shown in the screenshot. Alternatively you can open the command palette (`Ctrl+Shift+P`) and run **CMake: Select Variant**. Afterwards reconfiguring your project might be necessary. This could be done via the command palette, running **CMake: Configure**.

![CMake variants selection](../images/cmake-variants.png)

More about `cmake-variants.yaml` in the [About CMake variants](../README.md#about-cmake-variants) section.

## Using lcov to generate coverage info file

Install lcov:

    apt install lcov

Running `lcov` in your build directory **before** running the tests (not necessary as far as i saw):

    lcov --no-external --capture --initial --directory .. --output-file lcov.info

Running `lcov` in your build directory **after** running the tests:

    lcov --no-external --capture --directory .. --output-file lcov.info

To filter out unwanted results (e.g. STL headers and externals), use:

    lcov --remove lcov.info '/usr/*' '*/googletest/*' --output-file lcov.info

Add path to your info file in VS Code `settings.json`

    "markiscodecoverage.searchCriteria": "<build path>/lcov.info"

## Automate coverage extraction with tasks

A powerful tool, to automate the commands that have to be executed for coverage generation and extraction into HTML, are tasks.

Some sample how to run lcov and filter unwanted results afterwards.

    {
        "version": "2.0.0",
        "tasks": [
       {
            "label": "lcov",
            "type": "shell",
            "command": "lcov",
            "options": {
                "cwd": "${workspaceFolder}"
            },
            "args": [
                "--capture",
                "--directory",
                ".",
                "--output-file",
                "lcov.info"
            ]
        }] 
    }

See the `.vscode/tasks.json` for a more detailed example that runs lcov, filters the result, runs genhtml to generate a HTML report and finally starts firefox to display it.
The build/scan folders and the browser should be configured to match your setup.

To run the tasks, open the command palette (`Ctrl+Shift+P`) and run **Tasks: Run Task**. A nice alternative to that is the use of an extension like [Task Explorer](https://marketplace.visualstudio.com/items?itemName=spmeesseman.vscode-taskexplorer) that helps you to show and manage the tasks.

So a typical workflow could be:

- Run your tests with coverage instrumentation (see [Coverage with CMake builds](#setup-coverage-for-cmake-builds))
- Run lcov & genhtml & open report in HTML

<!-- TODO: More about tasks in Tasks section -->

---

## Extension

[This](https://marketplace.visualstudio.com/items?itemName=markis.code-coverage) extension helps you to get some coverage information from your tests based on data generated by lcov.
